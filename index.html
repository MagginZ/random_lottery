<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>彩票智能随机号码生成器</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        h1 {
            text-align: center;
            color: #e74c3c;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #e74c3c;
        }
        
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: monospace;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #c0392b;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .mode-switch {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .mode-button {
            padding: 10px 20px;
            border: 2px solid #e74c3c;
            background-color: white;
            color: #e74c3c;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-button.active {
            background-color: #e74c3c;
            color: white;
        }
        
        .mode-button:first-child {
            border-radius: 4px 0 0 4px;
        }
        
        .mode-button:last-child {
            border-radius: 0 4px 4px 0;
        }
        
        .result-container {
            margin-top: 20px;
        }
        
        .lottery-numbers {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .lottery-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .ball {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: bold;
            color: white;
            margin: 0 5px;
        }
        
        .front-ball {
            background-color: #e74c3c;
        }
        
        .back-ball {
            background-color: #3498db;
        }
        
        .separator {
            font-weight: bold;
            font-size: 20px;
            margin: 0 10px;
        }
        
        .stats-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .stats-section {
            flex: 1;
            min-width: 300px;
        }
        
        .number-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
        }
        
        .back-number-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        
        .number-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        
        .number-value {
            font-weight: bold;
        }
        
        .frequency-bar {
            width: 100%;
            height: 5px;
            background-color: #eee;
            margin-top: 5px;
            position: relative;
        }
        
        .frequency-fill {
            position: absolute;
            height: 100%;
            background-color: #e74c3c;
        }
        
        .back-frequency-fill {
            background-color: #3498db;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .file-label:hover {
            background-color: #2980b9;
        }
        
        .example-format {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
        }
        
        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .history-index {
            width: 100px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .history-numbers {
            display: flex;
            align-items: center;
        }
        
        .high-frequency {
            position: relative;
        }
        
        .high-frequency::after {
            content: "★";
            position: absolute;
            top: -5px;
            right: -5px;
            color: #f1c40f;
            font-size: 14px;
        }
        
        .final-ball {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-weight: bold;
            color: white;
            margin: 0 5px;
            font-size: 18px;
        }
        
        .final-front-ball {
            background-color: #e74c3c;
        }
        
        .final-back-ball {
            background-color: #3498db;
        }
        
        .final-separator {
            font-weight: bold;
            font-size: 24px;
            margin: 0 15px;
        }
        
        .final-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #e74c3c;
        }
        
        .final-logic {
            margin-top: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 3px solid #e74c3c;
        }
        
        .history-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            margin-top: 20px;
        }
        
        .mode-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            color: #777;
        }
    </style>
</head>
<body>
    <h1>彩票智能随机号码生成器</h1>
    
    <div class="mode-switch">
        <div class="mode-button active" id="dltMode">大乐透模式</div>
        <div class="mode-button" id="ssqMode">双色球模式</div>
    </div>
    
    <div class="mode-info" id="modeInfo">
        当前模式：大乐透（前区1-35选5，后区1-12选2）
    </div>
    
    <div class="container">
        <div class="section">
            <div class="section-title">历史数据输入</div>
            <p>请输入历史开奖号码，每行一组，格式：前区数字，后区数字</p>
            <div class="example-format" id="exampleFormat">例如：03 12 18 25 33 05 11 或 03,12,18,25,33,05,11</div>
            <div class="example-format">
                <a href="https://www.lottery.gov.cn/kj/kjlb.html?dlt" target="_blank" rel="noopener noreferrer" id="officialLink">
                    查看官方大乐透历史开奖数据 →
                </a>
            </div>
            <textarea id="historyData" placeholder="输入历史开奖号码，每行一组..."></textarea>
            <div class="error-message" id="dataError"></div>
            <div class="button-group">
                <button id="analyzeBtn">分析数据</button>
                <input type="file" id="fileInput" class="file-input" accept=".txt,.csv">
                <label for="fileInput" class="file-label">上传文件</label>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">号码生成</div>
            <div class="button-group">
                <button id="generateBtn" disabled>生成号码</button>
                <button id="generateFinalBtn" disabled>智能合成最终号码</button>
                <button id="resetBtn" disabled>重置</button>
            </div>
            
            <div class="result-container" id="resultContainer">
                <div class="section-title">生成结果</div>
                <div class="lottery-numbers" id="lotteryNumbers">
                    <!-- 生成的号码将显示在这里 -->
                </div>
                
                <div class="final-result" id="finalResult" style="display: none;">
                    <div class="final-title">最终智能合成号码</div>
                    <div class="final-row" id="finalRow">
                        <!-- 最终号码将显示在这里 -->
                    </div>
                    <div class="final-logic" id="finalLogic">
                        <!-- 合成逻辑将显示在这里 -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section" id="statsSection" style="display: none;">
            <div class="section-title">数据分析</div>
            <div class="stats-container">
                <div class="stats-section">
                    <h3>前区号码频率</h3>
                    <div class="number-stats" id="frontStats"></div>
                </div>
                <div class="stats-section">
                    <h3>后区号码频率</h3>
                    <div class="back-number-stats" id="backStats"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let frontFrequency = {}; // 前区号码频率
        let backFrequency = {}; // 后区号码频率
        let dataAnalyzed = false; // 数据是否已分析
        let generationHistory = []; // 生成历史
        let finalNumbersGenerated = false; // 是否已生成最终号码
        let currentMode = 'dlt'; // 当前模式：dlt(大乐透) 或 ssq(双色球)
        
        // 彩票模式配置
        const lotteryModes = {
            dlt: {
                name: '大乐透',
                frontRange: 35,
                frontCount: 5,
                backRange: 12,
                backCount: 2,
                frontHighFreqRequired: 3,
                backHighFreqRequired: 1,
                coldThreshold: 0.08,
                coldPeriods: 100,
                officialUrl: 'https://www.lottery.gov.cn/kj/kjlb.html?dlt',
                exampleFormat: '例如：03 12 18 25 33 05 11 或 03,12,18,25,33,05,11'
            },
            ssq: {
                name: '双色球',
                frontRange: 33,
                frontCount: 6,
                backRange: 16,
                backCount: 1,
                frontHighFreqRequired: 4,
                backHighFreqRequired: 0,
                coldThreshold: 0.08,
                coldPeriods: 50,
                officialUrl: 'https://m.17500.cn/kj-m/list-ssq.html',
                exampleFormat: '例如：01 11 15 25 26 33 16 或 01,11,15,25,26,33,16'
            }
        };
        
        // DOM 元素
        const historyDataInput = document.getElementById('historyData');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const generateBtn = document.getElementById('generateBtn');
        const generateFinalBtn = document.getElementById('generateFinalBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultContainer = document.getElementById('resultContainer');
        const lotteryNumbers = document.getElementById('lotteryNumbers');
        const statsSection = document.getElementById('statsSection');
        const frontStats = document.getElementById('frontStats');
        const backStats = document.getElementById('backStats');
        const fileInput = document.getElementById('fileInput');
        const dataError = document.getElementById('dataError');
        const finalResult = document.getElementById('finalResult');
        const finalRow = document.getElementById('finalRow');
        const finalLogic = document.getElementById('finalLogic');
        const dltModeBtn = document.getElementById('dltMode');
        const ssqModeBtn = document.getElementById('ssqMode');
        const modeInfo = document.getElementById('modeInfo');
        const exampleFormat = document.getElementById('exampleFormat');
        const officialLink = document.getElementById('officialLink');
        
        // 初始化频率数据
        function initFrequencyData() {
            frontFrequency = {};
            backFrequency = {};
            
            const mode = lotteryModes[currentMode];
            
            // 初始化前区号码频率
            for (let i = 1; i <= mode.frontRange; i++) {
                frontFrequency[i] = 0;
            }
            
            // 初始化后区号码频率
            for (let i = 1; i <= mode.backRange; i++) {
                backFrequency[i] = 0;
            }
        }
        
        
        // 完全重置
        function resetAll() {
            resetGenerationHistory();
            dataAnalyzed = false;
            initFrequencyData();
            statsSection.style.display = 'none';
            generateBtn.disabled = true;
        }
        
        // 分析历史数据
        function analyzeData() {
            const data = historyDataInput.value.trim();
            if (!data) {
                showError("请输入历史开奖数据");
                return;
            }
            
            initFrequencyData();
            
            const mode = lotteryModes[currentMode];
            const totalNumbers = mode.frontCount + mode.backCount;
            
            // 分割多行数据
            const lines = data.split('\n');
            let validLines = 0;
            
            for (const line of lines) {
                if (!line.trim()) continue;
                
                // 支持空格或逗号分隔
                let numbers;
                if (line.includes(',')) {
                    numbers = line.split(',').map(n => parseInt(n.trim()));
                } else {
                    numbers = line.split(/\s+/).map(n => parseInt(n.trim()));
                }
                
                // 验证数据格式
                if (numbers.length !== totalNumbers || numbers.some(isNaN)) {
                    continue;
                }
                
                // 验证数字范围
                const frontNumbers = numbers.slice(0, mode.frontCount);
                const backNumbers = numbers.slice(mode.frontCount, totalNumbers);
                
                const validFront = frontNumbers.every(n => n >= 1 && n <= mode.frontRange);
                const validBack = backNumbers.every(n => n >= 1 && n <= mode.backRange);
                
                if (!validFront || !validBack) {
                    continue;
                }
                
                // 统计频率
                frontNumbers.forEach(n => frontFrequency[n]++);
                backNumbers.forEach(n => backFrequency[n]++);
                
                validLines++;
            }
            
            if (validLines === 0) {
                showError(`没有有效的数据行，请检查格式是否符合${mode.name}规则`);
                return;
            }
            
            showError(""); // 清除错误信息
            dataAnalyzed = true;
            generateBtn.disabled = false;
            resetBtn.disabled = true;
            
            // 显示统计数据
            displayStats();
            statsSection.style.display = 'block';
        }
        
        // 显示统计数据
        function displayStats() {
            const mode = lotteryModes[currentMode];
            
            // 计算最大频率，用于显示比例
            const maxFrontFreq = Math.max(...Object.values(frontFrequency));
            const maxBackFreq = Math.max(...Object.values(backFrequency));
            
            // 显示前区统计
            frontStats.innerHTML = '';
            for (let i = 1; i <= mode.frontRange; i++) {
                const freq = frontFrequency[i];
                const percentage = (freq / maxFrontFreq) * 100;
                
                const statElement = document.createElement('div');
                statElement.className = 'number-stat';
                statElement.innerHTML = `
                    <span class="number-value">${i}</span>
                    <span>${freq}</span>
                    <div class="frequency-bar">
                        <div class="frequency-fill" style="width: ${percentage}%"></div>
                    </div>
                `;
                frontStats.appendChild(statElement);
            }
            
            // 显示后区统计
            backStats.innerHTML = '';
            for (let i = 1; i <= mode.backRange; i++) {
                const freq = backFrequency[i];
                const percentage = (freq / maxBackFreq) * 100;
                
                const statElement = document.createElement('div');
                statElement.className = 'number-stat';
                statElement.innerHTML = `
                    <span class="number-value">${i}</span>
                    <span>${freq}</span>
                    <div class="frequency-bar">
                        <div class="frequency-fill back-frequency-fill" style="width: ${percentage}%"></div>
                    </div>
                `;
                backStats.appendChild(statElement);
            }
        }
        
        // 根据频率计算权重
        function calculateWeights(frequency) {
            const weights = {};
            const values = Object.values(frequency);
            const maxFreq = Math.max(...values);
            const minFreq = Math.min(...values);
            const range = maxFreq - minFreq;
            
            // 权重计算公式：基础权重 + 频率调整
            // 基础权重确保随机性，频率调整提供历史偏好
            for (const [num, freq] of Object.entries(frequency)) {
                // 基础权重为0.7，频率调整为0.3
                const baseWeight = 0.7;
                const freqWeight = range > 0 ? 0.3 * ((freq - minFreq) / range) : 0;
                weights[num] = baseWeight + freqWeight;
            }
            
            return weights;
        }
        
        // 根据权重随机选择数字
        function weightedRandom(weights, count, range) {
            const numbers = [];
            const availableNumbers = [...Array(range).keys()].map(i => i + 1);
            
            while (numbers.length < count && availableNumbers.length > 0) {
                // 计算总权重
                let totalWeight = 0;
                for (const num of availableNumbers) {
                    totalWeight += weights[num];
                }
                
                // 随机选择
                let random = Math.random() * totalWeight;
                let selectedIndex = -1;
                
                for (let i = 0; i < availableNumbers.length; i++) {
                    const num = availableNumbers[i];
                    random -= weights[num];
                    
                    if (random <= 0) {
                        selectedIndex = i;
                        break;
                    }
                }
                
                // 如果没有选中，选择最后一个
                if (selectedIndex === -1) {
                    selectedIndex = availableNumbers.length - 1;
                }
                
                // 添加选中的数字并从可用列表中移除
                numbers.push(availableNumbers[selectedIndex]);
                availableNumbers.splice(selectedIndex, 1);
            }
            
            return numbers.sort((a, b) => a - b);
        }
        
        // 生成号码
        function generateNumbers() {
            if (!dataAnalyzed) {
                showError("请先分析历史数据");
                return null;
            }
            
            // 清空之前的结果
            lotteryNumbers.innerHTML = '';
            generationHistory = [];
            finalNumbersGenerated = false;
            finalResult.style.display = 'none';
            
            // 一次性生成5组号码
            for (let i = 0; i < 5; i++) {
                // 计算权重
                const frontWeights = calculateWeights(frontFrequency);
                const backWeights = calculateWeights(backFrequency);
                
                // 生成号码
                const frontNumbers = weightedRandom(frontWeights, lotteryModes[currentMode].frontCount, lotteryModes[currentMode].frontRange);
                const backNumbers = weightedRandom(backWeights, lotteryModes[currentMode].backCount, lotteryModes[currentMode].backRange);
                
                const numbers = {
                    front: frontNumbers,
                    back: backNumbers
                };
                
                // 添加到历史记录
                generationHistory.push(numbers);
                
                // 显示号码
                displayNumbers(numbers, i === 0);
            }
            
            // 启用生成最终号码按钮，禁用生成号码按钮
            generateFinalBtn.disabled = false;
            generateBtn.disabled = true; // 禁用生成号码按钮
            resetBtn.disabled = false;
            
            return generationHistory;
        }
        
        
        // 显示生成的号码
        function displayNumbers(numbers, clear = true) {
            if (clear) {
                lotteryNumbers.innerHTML = '';
            }
            
            const index = generationHistory.indexOf(numbers);
            
            const row = document.createElement('div');
            row.className = 'lottery-row';
            
            // 添加序号
            const indexElement = document.createElement('div');
            indexElement.className = 'row-index';
            indexElement.textContent = `第${index + 1}组:`;
            row.appendChild(indexElement);
            
            // 前区号码
            numbers.front.forEach(num => {
                const ball = document.createElement('div');
                ball.className = 'ball front-ball';
                ball.textContent = num.toString().padStart(2, '0');
                row.appendChild(ball);
            });
            
            // 分隔符
            const separator = document.createElement('div');
            separator.className = 'separator';
            separator.textContent = '|';
            row.appendChild(separator);
            
            // 后区号码
            numbers.back.forEach(num => {
                const ball = document.createElement('div');
                ball.className = 'ball back-ball';
                ball.textContent = num.toString().padStart(2, '0');
                row.appendChild(ball);
            });
            
            lotteryNumbers.appendChild(row);
        }
        
       // 重置生成历史
       function resetGenerationHistory() {
            generationHistory = [];
            finalNumbersGenerated = false;
            finalResult.style.display = 'none';
            lotteryNumbers.innerHTML = '';
            generateFinalBtn.disabled = true;
            generateBtn.disabled = false; // 重新启用生成按钮
            resetBtn.disabled = true;
        }
        
        // 添加到生成历史
        function addToHistory(numbers) {
            if (generationHistory.length >= 5 || finalNumbersGenerated) {
                return false;
            }
            
            generationHistory.push(numbers);
            updateHistoryDisplay();
            
            // 如果已经生成了5组，启用生成最终号码按钮并禁用生成按钮
            if (generationHistory.length === 5) {
                generateFinalBtn.disabled = false;
                generateBtn.disabled = true;
                resetBtn.disabled = false;
            }
            
            return true;
        }
        
        // 更新历史显示
        function updateHistoryDisplay() {
            historyList.innerHTML = '';
            generationCount.textContent = generationHistory.length;
            
            // 计算高频数字
            const highFreqFront = getHighFrequencyNumbers('front');
            const highFreqBack = getHighFrequencyNumbers('back');
            
            generationHistory.forEach((numbers, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const indexElement = document.createElement('div');
                indexElement.className = 'history-index';
                indexElement.textContent = `第${index + 1}次生成:`;
                historyItem.appendChild(indexElement);
                
                const numbersContainer = document.createElement('div');
                numbersContainer.className = 'history-numbers';
                
                // 前区号码
                numbers.front.forEach(num => {
                    const ball = document.createElement('div');
                    ball.className = 'ball front-ball';
                    if (highFreqFront.includes(num)) {
                        ball.classList.add('high-frequency');
                    }
                    ball.textContent = num.toString().padStart(2, '0');
                    numbersContainer.appendChild(ball);
                });
                
                // 分隔符
                const separator = document.createElement('div');
                separator.className = 'separator';
                separator.textContent = '|';
                numbersContainer.appendChild(separator);
                
                // 后区号码
                numbers.back.forEach(num => {
                    const ball = document.createElement('div');
                    ball.className = 'ball back-ball';
                    if (highFreqBack.includes(num)) {
                        ball.classList.add('high-frequency');
                    }
                    ball.textContent = num.toString().padStart(2, '0');
                    numbersContainer.appendChild(ball);
                });
                
                historyItem.appendChild(numbersContainer);
                historyList.appendChild(historyItem);
            });
        }
        
        // 获取高频数字（出现次数 >= 2）
        function getHighFrequencyNumbers(area) {
            if (generationHistory.length < 2) return [];
            
            const frequency = {};
            const mode = lotteryModes[currentMode];
            
            // 初始化频率
            const range = area === 'front' ? mode.frontRange : mode.backRange;
            for (let i = 1; i <= range; i++) {
                frequency[i] = 0;
            }
            
            // 统计频率
            generationHistory.forEach(numbers => {
                numbers[area].forEach(num => {
                    frequency[num] = (frequency[num] || 0) + 1;
                });
            });
            
            // 筛选高频数字
            return Object.entries(frequency)
                .filter(([_, freq]) => freq >= 2)
                .map(([num, _]) => parseInt(num))
                .sort((a, b) => a - b);
        }
        
        // 重置生成历史
        function resetGenerationHistory() {
            generationHistory = [];
            finalNumbersGenerated = false;
            finalResult.style.display = 'none';
            lotteryNumbers.innerHTML = '';
            generateFinalBtn.disabled = true;
            generateBtn.disabled = false;
            resetBtn.disabled = true;
        }
        
        // 生成最终号码
                // 生成最终号码
                function generateFinalNumbers() {
            if (generationHistory.length < 5) {
                showError("请先生成5组号码");
                return;
            }
            
            const mode = lotteryModes[currentMode];
            
            // 获取高频数字
            const highFreqFront = getHighFrequencyNumbers('front');
            const highFreqBack = getHighFrequencyNumbers('back');
            
            // 检查是否需要包含冷门号码
            const needColdNumbers = checkNeedColdNumbers();
            
            // 前区号码选择
            let frontNumbers = [];
            let frontHighFreq = [];
            
            // 根据模式确定需要包含的高频数字数量
            const requiredHighFreqCount = currentMode === 'dlt' ? 3 : 4;
            
            // 如果高频数字足够，优先选择高频数字
            if (highFreqFront.length >= requiredHighFreqCount) {
                // 随机选择指定数量的高频数字
                frontHighFreq = selectRandomSubset(highFreqFront, requiredHighFreqCount);
                frontNumbers = [...frontHighFreq];
                
                // 补充剩余数字
                const remainingCount = mode.frontCount - frontNumbers.length;
                if (remainingCount > 0) {
                    // 计算权重
                    const frontWeights = calculateWeights(frontFrequency);
                    
                    // 排除已选数字
                    const availableNumbers = [];
                    for (let i = 1; i <= mode.frontRange; i++) {
                        if (!frontNumbers.includes(i)) {
                            availableNumbers.push(i);
                        }
                    }
                    
                    // 如果需要包含冷门号码
                    if (needColdNumbers.front && remainingCount > 0) {
                        const coldestNumber = findColdestNumber(frontFrequency);
                        if (!frontNumbers.includes(coldestNumber)) {
                            frontNumbers.push(coldestNumber);
                        }
                    }
                    
                    // 补充剩余数字
                    while (frontNumbers.length < mode.frontCount) {
                        const weights = {};
                        availableNumbers.forEach(num => {
                            weights[num] = frontWeights[num];
                        });
                        
                        const selected = weightedRandom(weights, 1, availableNumbers.length)[0];
                        frontNumbers.push(selected);
                        
                        // 从可用数字中移除已选数字
                        const index = availableNumbers.indexOf(selected);
                        if (index !== -1) {
                            availableNumbers.splice(index, 1);
                        }
                    }
                }
            } else {
                // 高频数字不足，直接使用所有高频数字
                frontHighFreq = [...highFreqFront];
                frontNumbers = [...highFreqFront];
                
                // 补充剩余数字
                const remainingCount = mode.frontCount - frontNumbers.length;
                if (remainingCount > 0) {
                    // 计算权重
                    const frontWeights = calculateWeights(frontFrequency);
                    
                    // 排除已选数字
                    const availableNumbers = [];
                    for (let i = 1; i <= mode.frontRange; i++) {
                        if (!frontNumbers.includes(i)) {
                            availableNumbers.push(i);
                        }
                    }
                    
                    // 如果需要包含冷门号码
                    if (needColdNumbers.front && remainingCount > 0) {
                        const coldestNumber = findColdestNumber(frontFrequency);
                        if (!frontNumbers.includes(coldestNumber)) {
                            frontNumbers.push(coldestNumber);
                        }
                    }
                    
                    // 补充剩余数字
                    while (frontNumbers.length < mode.frontCount) {
                        const weights = {};
                        availableNumbers.forEach(num => {
                            weights[num] = frontWeights[num];
                        });
                        
                        const selected = weightedRandom(weights, 1, availableNumbers.length)[0];
                        frontNumbers.push(selected);
                        
                        // 从可用数字中移除已选数字
                        const index = availableNumbers.indexOf(selected);
                        if (index !== -1) {
                            availableNumbers.splice(index, 1);
                        }
                    }
                }
            }
            
            // 后区号码选择
            let backNumbers = [];
            let backHighFreq = [];
            
            // 大乐透模式需要包含至少1个高频后区号码
            if (currentMode === 'dlt' && highFreqBack.length > 0) {
                // 随机选择1个高频号码
                backHighFreq = selectRandomSubset(highFreqBack, 1);
                backNumbers = [...backHighFreq];
                
                // 补充剩余数字
                const remainingCount = mode.backCount - backNumbers.length;
                if (remainingCount > 0) {
                    // 计算权重
                    const backWeights = calculateWeights(backFrequency);
                    
                    // 排除已选数字
                    const availableNumbers = [];
                    for (let i = 1; i <= mode.backRange; i++) {
                        if (!backNumbers.includes(i)) {
                            availableNumbers.push(i);
                        }
                    }
                    
                    // 如果需要包含冷门号码
                    if (needColdNumbers.back && remainingCount > 0) {
                        const coldestNumber = findColdestNumber(backFrequency);
                        if (!backNumbers.includes(coldestNumber)) {
                            backNumbers.push(coldestNumber);
                        }
                    }
                    
                    // 补充剩余数字
                    while (backNumbers.length < mode.backCount) {
                        const weights = {};
                        availableNumbers.forEach(num => {
                            weights[num] = backWeights[num];
                        });
                        
                        const selected = weightedRandom(weights, 1, availableNumbers.length)[0];
                        backNumbers.push(selected);
                        
                        // 从可用数字中移除已选数字
                        const index = availableNumbers.indexOf(selected);
                        if (index !== -1) {
                            availableNumbers.splice(index, 1);
                        }
                    }
                }
            } else {
                // 双色球模式或没有高频后区号码
                backHighFreq = [...highFreqBack];
                
                // 计算权重
                const backWeights = calculateWeights(backFrequency);
                
                // 如果有高频号码，优先使用
                if (backHighFreq.length > 0 && backHighFreq.length >= mode.backCount) {
                    backNumbers = selectRandomSubset(backHighFreq, mode.backCount);
                } else if (backHighFreq.length > 0) {
                    // 高频号码不足，使用所有高频号码
                    backNumbers = [...backHighFreq];
                    
                    // 补充剩余数字
                    const remainingCount = mode.backCount - backNumbers.length;
                    if (remainingCount > 0) {
                        // 排除已选数字
                        const availableNumbers = [];
                        for (let i = 1; i <= mode.backRange; i++) {
                            if (!backNumbers.includes(i)) {
                                availableNumbers.push(i);
                            }
                        }
                        
                        // 如果需要包含冷门号码
                        if (needColdNumbers.back && remainingCount > 0) {
                            const coldestNumber = findColdestNumber(backFrequency);
                            if (!backNumbers.includes(coldestNumber)) {
                                backNumbers.push(coldestNumber);
                            }
                        }
                        
                        // 补充剩余数字
                        while (backNumbers.length < mode.backCount) {
                            const weights = {};
                            availableNumbers.forEach(num => {
                                weights[num] = backWeights[num];
                            });
                            
                            const selected = weightedRandom(weights, 1, availableNumbers.length)[0];
                            backNumbers.push(selected);
                            
                            // 从可用数字中移除已选数字
                            const index = availableNumbers.indexOf(selected);
                            if (index !== -1) {
                                availableNumbers.splice(index, 1);
                            }
                        }
                    }
                } else {
                    // 没有高频号码，直接随机生成
                    backNumbers = weightedRandom(backWeights, mode.backCount, mode.backRange);
                }
            }
            
            // 排序
            frontNumbers.sort((a, b) => a - b);
            backNumbers.sort((a, b) => a - b);
            
            const finalNumbers = {
                front: frontNumbers,
                back: backNumbers,
                frontHighFreq: frontHighFreq,
                backHighFreq: backHighFreq,
                coldFront: needColdNumbers.front ? findColdestNumber(frontFrequency) : null,
                coldBack: needColdNumbers.back ? findColdestNumber(backFrequency) : null
            };
            
            // 显示最终号码
            displayFinalNumbers(finalNumbers);
            
            finalNumbersGenerated = true;
            generateFinalBtn.disabled = true;
            generateBtn.disabled = true;
            
            return finalNumbers;
        }
        
        // 随机选择子集
        function selectRandomSubset(array, count) {
            if (array.length <= count) return [...array];
            
            const result = [];
            const copy = [...array];
            
            while (result.length < count && copy.length > 0) {
                const index = Math.floor(Math.random() * copy.length);
                result.push(copy[index]);
                copy.splice(index, 1);
            }
            
            return result;
        }
        
        // 检查是否需要包含冷门号码
        function checkNeedColdNumbers() {
            const mode = lotteryModes[currentMode];
            
            // 计算冷门阈值
            const frontThreshold = Object.values(frontFrequency).reduce((a, b) => a + b, 0) / mode.frontRange * 0.08;
            const backThreshold = Object.values(backFrequency).reduce((a, b) => a + b, 0) / mode.backRange * 0.08;
            
            // 找出冷门号码
            const coldFrontNumbers = Object.entries(frontFrequency)
                .filter(([_, freq]) => freq <= frontThreshold)
                .map(([num, _]) => parseInt(num));
            
            const coldBackNumbers = Object.entries(backFrequency)
                .filter(([_, freq]) => freq <= backThreshold)
                .map(([num, _]) => parseInt(num));
            
            // 检查5次生成结果中是否包含冷门号码
            let frontHasCold = false;
            let backHasCold = false;
            
            for (const numbers of generationHistory) {
                for (const num of numbers.front) {
                    if (coldFrontNumbers.includes(num)) {
                        frontHasCold = true;
                        break;
                    }
                }
                
                for (const num of numbers.back) {
                    if (coldBackNumbers.includes(num)) {
                        backHasCold = true;
                        break;
                    }
                }
            }
            
            return {
                front: !frontHasCold && coldFrontNumbers.length > 0,
                back: !backHasCold && coldBackNumbers.length > 0
            };
        }
        
        // 找出最冷门的号码
        function findColdestNumber(frequency) {
            let coldestNumber = 1;
            let minFrequency = Infinity;
            
            for (const [num, freq] of Object.entries(frequency)) {
                if (freq < minFrequency) {
                    minFrequency = freq;
                    coldestNumber = parseInt(num);
                }
            }
            
            return coldestNumber;
        }
        
        // 显示最终号码
        function displayFinalNumbers(numbers) {
            finalResult.style.display = 'block';
            finalRow.innerHTML = '';
            
            // 模式名称
            const modeName = currentMode === 'dlt' ? '大乐透' : '双色球';
            
            // 标题
            const titleElement = document.createElement('div');
            titleElement.className = 'final-title';
            titleElement.textContent = `【最终号码-${modeName}】`;
            finalRow.appendChild(titleElement);
            
            // 号码容器
            const numbersContainer = document.createElement('div');
            numbersContainer.className = 'final-numbers';
            
            // 前区号码
            numbers.front.forEach(num => {
                const ball = document.createElement('div');
                ball.className = 'final-ball final-front-ball';
                
                // 如果是高频号码，添加星标
                const isHighFreq = numbers.frontHighFreq.includes(num);
                // 如果是冷门号码，添加特殊标记
                const isCold = numbers.coldFront === num;
                
                ball.textContent = num.toString().padStart(2, '0');
                if (isHighFreq) ball.innerHTML += '★';
                if (isCold) ball.innerHTML += '❄';
                
                numbersContainer.appendChild(ball);
            });
            
            // 分隔符
            const separator = document.createElement('div');
            separator.className = 'final-separator';
            separator.textContent = '|';
            numbersContainer.appendChild(separator);
            
            // 后区号码
            numbers.back.forEach(num => {
                const ball = document.createElement('div');
                ball.className = 'final-ball final-back-ball';
                
                // 如果是高频号码，添加星标
                const isHighFreq = numbers.backHighFreq.includes(num);
                // 如果是冷门号码，添加特殊标记
                const isCold = numbers.coldBack === num;
                
                ball.textContent = num.toString().padStart(2, '0');
                if (isHighFreq) ball.innerHTML += '★';
                if (isCold) ball.innerHTML += '❄';
                
                numbersContainer.appendChild(ball);
            });
            
            finalRow.appendChild(numbersContainer);
            
            // 显示合成逻辑
            const highFreqFrontCount = numbers.frontHighFreq.length;
            const highFreqBackCount = numbers.backHighFreq.length;
            const mode = lotteryModes[currentMode];
            
            let logicText = `<p>前区：${numbers.front.map(num => {
                const isHighFreq = numbers.frontHighFreq.includes(num);
                const isCold = numbers.coldFront === num;
                return (isHighFreq ? '★' : '') + num + (isCold ? '❄' : '');
            }).join(' ')}（${highFreqFrontCount}高频+${mode.frontCount-highFreqFrontCount}补充）</p>`;
            
            logicText += `<p>后区：${numbers.back.map(num => {
                const isHighFreq = numbers.backHighFreq.includes(num);
                const isCold = numbers.coldBack === num;
                return (isHighFreq ? '★' : '') + num + (isCold ? '❄' : '');
            }).join(' ')}（${highFreqBackCount}高频+${mode.backCount-highFreqBackCount}随机）</p>`;
            
            // 添加冷门号码说明
            if (numbers.coldFront !== null) {
                const coldFreq = frontFrequency[numbers.coldFront];
                const totalDraws = Object.values(frontFrequency).reduce((a, b) => a + b, 0) / mode.frontRange;
                const coldRate = (coldFreq / totalDraws * 100).toFixed(1);
                logicText += `<p>合成逻辑：覆盖5组高频数字+强制保留冷门数字${numbers.coldFront}（近期出现率${coldRate}%）</p>`;
            } else if (numbers.coldBack !== null) {
                const coldFreq = backFrequency[numbers.coldBack];
                const totalDraws = Object.values(backFrequency).reduce((a, b) => a + b, 0) / mode.backRange;
                const coldRate = (coldFreq / totalDraws * 100).toFixed(1);
                logicText += `<p>合成逻辑：覆盖5组高频数字+强制保留冷门数字${numbers.coldBack}（近期出现率${coldRate}%）</p>`;
            } else {
                logicText += `<p>合成逻辑：覆盖5组高频数字+权重随机补充</p>`;
            }
            
            finalLogic.innerHTML = logicText;
        }
        
        // 显示错误信息
        function showError(message) {
            dataError.textContent = message;
        }
        
        // 切换彩票模式
        function switchMode(mode) {
            if (currentMode === mode) return;
            
            // 重置数据
            resetGenerationHistory();
            
            // 更新模式
            currentMode = mode;
            
            // 更新UI
            dltModeBtn.classList.toggle('active', mode === 'dlt');
            ssqModeBtn.classList.toggle('active', mode === 'ssq');
            
            // 更新模式信息
            modeInfo.textContent = `当前模式：${mode === 'dlt' ? '大乐透（前区1-35选5，后区1-12选2）' : '双色球（前区1-33选6，后区1-16选1）'}`;
            
            // 更新示例格式
            exampleFormat.textContent = lotteryModes[mode].exampleFormat;
            
            // 更新官方链接
            officialLink.href = lotteryModes[mode].officialUrl;
            officialLink.textContent = `查看官方${mode === 'dlt' ? '大乐透' : '双色球'}历史开奖数据 →`;
            
            // 重新初始化频率数据
            initFrequencyData();
            
            // 清空分析结果
            dataAnalyzed = false;
            statsSection.style.display = 'none';
            generateBtn.disabled = true;
        }
        
        // 事件监听
        analyzeBtn.addEventListener('click', () => {
            analyzeData();
            if (dataAnalyzed) {
                generateBtn.disabled = false;
                resetBtn.disabled = true;
            }
        });
        
        generateBtn.addEventListener('click', () => {
            if (finalNumbersGenerated) {
                showError("已生成最终号码，请先重置");
                return;
            }
            
            generateNumbers();
        });
        
        generateFinalBtn.addEventListener('click', generateFinalNumbers);
        
        resetBtn.addEventListener('click', resetGenerationHistory);
        
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                historyDataInput.value = e.target.result;
            };
            reader.readAsText(file);
        });
        
        dltModeBtn.addEventListener('click', () => switchMode('dlt'));
        ssqModeBtn.addEventListener('click', () => switchMode('ssq'));
        
        // 初始化
        initFrequencyData();
    </script>
</body>
</html>